{% extends 'base.html' %}

{% block title %}Virtual USB Devices - OrangeUSB{% endblock %}

{% block head %}
<style>
    /* Стили для проводника директорий */
    .directory-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid rgba(0,0,0,.125);
        border-radius: .25rem;
    }
    
    .folder-item:hover {
        background-color: rgba(13, 110, 253, 0.1);
    }
    
    /* Стили для путей */
    #current_path {
        word-break: break-all;
        max-width: 300px;
        display: inline-block;
        vertical-align: middle;
    }
    
    /* Стили для неактивных элементов */
    .list-group-item[disabled] {
        pointer-events: none;
        opacity: 0.6;
    }
    
    /* Специфичные стили для страницы виртуальных устройств */
    .card {
        border-width: 1px !important;
        border-style: solid !important;
        border-color: rgba(255, 255, 255, 0.1) !important;
    }
    
    .device-col .card {
        margin-right: 2px !important;
    }
    
    .port-col .card {
        margin-left: 2px !important;
    }
    
    .table-responsive {
        width: 100% !important;
    }
    
    /* Убираем все отступы */
    .virtual-devices-container {
        padding: 0 !important;
        width: 100vw !important;
        max-width: 100% !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Колонка виртуальных устройств -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="fas fa-microchip me-2"></i>Virtual Devices</h4>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createDeviceModal">
                    <i class="fas fa-plus me-1"></i>Create Device
                </button>
            </div>
            <div class="card-body p-0">
                {% if virtual_devices %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>VID:PID</th>
                                <th>Status</th>
                                <th>Info</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for device in virtual_devices %}
                            <tr>
                                <td>{{ device.name }}</td>
                                <td>
                                    {% if device.device_type == 'hid' %}
                                        <span class="badge bg-primary">HID Device</span>
                                    {% elif device.device_type == 'storage' %}
                                        <span class="badge bg-info">Storage</span>
                                        {% if device.is_system_path %}
                                            <span class="badge bg-warning">System Folder</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Virtual</span>
                                        {% endif %}
                                    {% elif device.device_type == 'serial' %}
                                        <span class="badge bg-secondary">COM Port</span>
                                    {% elif device.device_type == 'ethernet' %}
                                        <span class="badge bg-dark">Network</span>
                                    {% elif device.device_type == 'audio' %}
                                        <span class="badge bg-success">Audio</span>
                                    {% elif device.device_type == 'printer' %}
                                        <span class="badge bg-danger">Printer</span>
                                    {% elif device.device_type == 'camera' %}
                                        <span class="badge bg-warning">Camera</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">{{ device.device_type }}</span>
                                    {% endif %}
                                </td>
                                <td><code>{{ device.vendor_id }}:{{ device.product_id }}</code></td>
                                <td>
                                    {% if device.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if device.device_type == 'storage' %}
                                        <small>
                                        {% if device.is_system_path and device.storage_path %}
                                            <strong>Path: </strong>
                                            <span class="text-break d-inline-block" style="max-width: 150px;">
                                                <code>{{ device.storage_path }}</code>
                                            </span><br>
                                        {% endif %}
                                        <strong>Size: </strong>{{ device.storage_size }} MB
                                        </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex flex-wrap gap-1">
                                        <button class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#connectDeviceModal"
                                                data-device-id="{{ device.id }}"
                                                data-device-name="{{ device.name }}">
                                            <i class="fas fa-plug me-1"></i>Connect
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-device-btn"
                                                data-device-id="{{ device.id }}"
                                                data-device-name="{{ device.name }}">
                                            <i class="fas fa-trash me-1"></i>Delete
                                        </button>
                                        {% if device.device_type == 'storage' %}
                                            <a href="{{ url_for('storage.manage_storage', device_id=device.id) }}" class="btn btn-sm btn-outline-info">
                                                <i class="fas fa-hdd me-1"></i>Files
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info m-3">
                    <i class="fas fa-info-circle me-2"></i>No virtual devices
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Колонка виртуальных портов -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="fas fa-plug me-2"></i>Virtual Ports</h4>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createPortModal">
                    <i class="fas fa-plus me-1"></i>Create Port
                </button>
            </div>
            <div class="card-body p-0">
                {% if virtual_ports %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Number</th>
                                <th>Device</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for port in virtual_ports %}
                            <tr>
                                <td>{{ port.name }}</td>
                                <td><code>{{ port.port_number }}</code></td>
                                <td>
                                    {% if port.device %}
                                        {{ port.device.name }}
                                    {% else %}
                                        <span class="text-muted">Not Connected</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if port.is_connected %}
                                        <span class="badge bg-success">Connected</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Disconnected</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% if port.is_connected %}
                                            <form method="POST" action="{{ url_for('disconnect_virtual_device') }}" class="d-inline">
                                                <input type="hidden" name="port_id" value="{{ port.id }}">
                                                <button type="submit" class="btn btn-sm btn-outline-warning">
                                                    <i class="fas fa-unlink me-1"></i>Disconnect
                                                </button>
                                            </form>
                                        {% else %}
                                            <button class="btn btn-sm btn-outline-primary"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#connectDeviceModal"
                                                    data-port-id="{{ port.id }}"
                                                    data-port-name="{{ port.name }}">
                                                <i class="fas fa-link me-1"></i>Connect
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-danger delete-port-btn"
                                                data-port-id="{{ port.id }}"
                                                data-port-name="{{ port.name }}">
                                            <i class="fas fa-trash me-1"></i>Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info m-3">
                    <i class="fas fa-info-circle me-2"></i>No virtual ports
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно создания виртуального устройства -->
<div class="modal fade" id="createDeviceModal" tabindex="-1" aria-labelledby="createDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createDeviceModalLabel">Create Virtual Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('create_virtual_device') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Device Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="device_type" class="form-label">Device Type</label>
                        <select class="form-select" id="device_type" name="device_type" required>
                            {% for type in device_types %}
                                <option value="{{ type.id }}">{{ type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Настройки для устройств хранения (storage) -->
                    <div class="storage-options mb-3" style="display: none;">
                        <div class="card">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0">Storage Settings</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="use_system_folder" name="use_system_folder">
                                        <label class="form-check-label" for="use_system_folder">Use existing system folder</label>
                                    </div>
                                </div>
                                
                                <!-- Опции для нового виртуального хранилища -->
                                <div id="virtual_storage_options">
                                    <div class="mb-3">
                                        <label for="storage_size" class="form-label">Storage Size (MB)</label>
                                        <input type="number" class="form-control" id="storage_size" name="storage_size" 
                                               value="1024" min="1" max="16384">
                                        <div class="form-text">Storage size description</div>
                                    </div>
                                </div>
                                
                                <!-- Опции для существующей системной папки -->
                                <div id="system_folder_options" style="display: none;">
                                    <div class="mb-3">
                                        <label for="system_path" class="form-label">System Folder Path</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="system_path" name="system_path" 
                                                   placeholder="/path/to/folder" readonly>
                                            <button type="button" class="btn btn-outline-primary" id="browse_button"
                                                    data-bs-toggle="modal" data-bs-target="#folderBrowserModal">
                                                <i class="fas fa-folder-open"></i> Select
                                            </button>
                                        </div>
                                        <div class="form-text">Select system folder description</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="system_storage_size" class="form-label">Virtual Storage Size (MB)</label>
                                        <input type="number" class="form-control" id="system_storage_size" name="system_storage_size" 
                                               value="1024" min="1" max="16384">
                                        <div class="form-text">Virtual storage size displayed in system</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="vendor_id" class="form-label">Vendor ID</label>
                            <input type="text" class="form-control" id="vendor_id" name="vendor_id" 
                                   placeholder="1a2b" pattern="[0-9a-fA-F]{4}" maxlength="4">
                            <div class="form-text">Hex format (4 characters)</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="product_id" class="form-label">Product ID</label>
                            <input type="text" class="form-control" id="product_id" name="product_id"
                                   placeholder="3c4d" pattern="[0-9a-fA-F]{4}" maxlength="4">
                            <div class="form-text">Hex format (4 characters)</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="serial_number" class="form-label">Serial Number (Optional)</label>
                        <input type="text" class="form-control" id="serial_number" name="serial_number">
                    </div>
                    <div class="mb-3">
                        <label for="config_json" class="form-label">Configuration (JSON, Optional)</label>
                        <textarea class="form-control" id="config_json" name="config_json" rows="3"></textarea>
                        <div class="form-text">JSON configuration description</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно создания виртуального порта -->
<div class="modal fade" id="createPortModal" tabindex="-1" aria-labelledby="createPortModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPortModalLabel">Create Virtual Port</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('create_virtual_port') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="port_name" class="form-label">Port Name</label>
                        <input type="text" class="form-control" id="port_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="port_number" class="form-label">Port Number (Optional)</label>
                        <input type="text" class="form-control" id="port_number" name="port_number" 
                               placeholder="Will be generated automatically">
                        <div class="form-text">If not specified, will be generated automatically</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно подключения устройства к порту -->
<div class="modal fade" id="connectDeviceModal" tabindex="-1" aria-labelledby="connectDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="connectDeviceModalLabel">Connect device to port</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('connect_virtual_device') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="connect_port_id" class="form-label">Select Port</label>
                        <select class="form-select" id="connect_port_id" name="port_id" required>
                            <option value="" selected disabled>Select Port...</option>
                            {% for port in virtual_ports %}
                                {% if not port.is_connected %}
                                    <option value="{{ port.id }}">{{ port.name }} ({{ port.port_number }})</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="connect_device_id" class="form-label">Select Device</label>
                        <select class="form-select" id="connect_device_id" name="device_id" required>
                            <option value="" selected disabled>Select Device...</option>
                            {% for device in virtual_devices %}
                                <option value="{{ device.id }}">{{ device.name }} ({{ device.vendor_id }}:{{ device.product_id }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Connect</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Скрытые формы для действий -->
<form id="deleteDeviceForm" method="POST" action="{{ url_for('delete_virtual_device') }}" style="display: none;">
    <input type="hidden" name="device_id" id="delete_device_id" value="">
</form>

<form id="deletePortForm" method="POST" action="{{ url_for('delete_virtual_port') }}" style="display: none;">
    <input type="hidden" name="port_id" id="delete_port_id" value="">
</form>
<!-- Модальное окно для выбора папки -->
<div class="modal fade" id="folderBrowserModal" tabindex="-1" aria-labelledby="folderBrowserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="folderBrowserModalLabel">Select Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 d-flex align-items-center">
                    <nav aria-label="Breadcrumb" class="flex-grow-1">
                        <ol class="breadcrumb mb-0" id="folder_breadcrumb">
                            <li class="breadcrumb-item"><a href="#" data-path="/">Root</a></li>
                        </ol>
                    </nav>
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="parent_dir_button">
                        <i class="fas fa-level-up-alt"></i> Up
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="refresh_dir_button">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                
                <div class="alert alert-warning" id="folder_browser_error" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i><span id="error_message"></span>
                </div>
                
                <div class="directory-list" id="directory_list">
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading folder list...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100 align-items-center">
                    <div>
                        <span class="me-2">Current Path:</span>
                        <code id="current_path">/</code>
                        <span class="ms-2 badge" id="writable_badge"></span>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="select_folder_button">Select</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработчики для удаления устройств
    document.querySelectorAll('.delete-device-btn').forEach(button => {
        button.addEventListener('click', function() {
            const deviceId = this.getAttribute('data-device-id');
            const deviceName = this.getAttribute('data-device-name');
            
            if (confirm(`Are you sure you want to delete device "${deviceName}"?`)) {
                document.getElementById('delete_device_id').value = deviceId;
                document.getElementById('deleteDeviceForm').submit();
            }
        });
    });
    
    // Обработчики для удаления портов
    document.querySelectorAll('.delete-port-btn').forEach(button => {
        button.addEventListener('click', function() {
            const portId = this.getAttribute('data-port-id');
            const portName = this.getAttribute('data-port-name');
            
            if (confirm(`Are you sure you want to delete port "${portName}"?`)) {
                document.getElementById('delete_port_id').value = portId;
                document.getElementById('deletePortForm').submit();
            }
        });
    });
    
    // Предзаполнение модального окна подключения
    const connectModal = document.getElementById('connectDeviceModal');
    if (connectModal) {
        connectModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            
            // Проверяем, есть ли атрибуты порта или устройства
            if (button.hasAttribute('data-port-id')) {
                const portId = button.getAttribute('data-port-id');
                const selectElement = document.getElementById('connect_port_id');
                if (selectElement) {
                    selectElement.value = portId;
                }
            }
            
            if (button.hasAttribute('data-device-id')) {
                const deviceId = button.getAttribute('data-device-id');
                const selectElement = document.getElementById('connect_device_id');
                if (selectElement) {
                    selectElement.value = deviceId;
                }
            }
        });
    }
    
    // Генерация случайных VID/PID при создании устройства
    document.getElementById('createDeviceModal')?.addEventListener('show.bs.modal', function () {
        // Генерируем случайные VID/PID, если поля пустые
        if (!document.getElementById('vendor_id').value) {
            const randomVid = Math.floor(Math.random() * 65535).toString(16).padStart(4, '0');
            document.getElementById('vendor_id').value = randomVid;
        }
        
        // Обработчик переключения между виртуальной и системной папкой
        const useSystemFolderCheckbox = document.getElementById('use_system_folder');
        const virtualStorageOptions = document.getElementById('virtual_storage_options');
        const systemFolderOptions = document.getElementById('system_folder_options');
        
        if (useSystemFolderCheckbox && virtualStorageOptions && systemFolderOptions) {
            useSystemFolderCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    virtualStorageOptions.style.display = 'none';
                    systemFolderOptions.style.display = 'block';
                } else {
                    virtualStorageOptions.style.display = 'block';
                    systemFolderOptions.style.display = 'none';
                }
            });
        }
        
        if (!document.getElementById('product_id').value) {
            const randomPid = Math.floor(Math.random() * 65535).toString(16).padStart(4, '0');
            document.getElementById('product_id').value = randomPid;
        }
    });
    
    // Показать/скрыть настройки хранилища в зависимости от типа устройства
    const deviceTypeSelect = document.getElementById('device_type');
    if (deviceTypeSelect) {
        function updateStorageOptions() {
            const storageOptions = document.querySelector('.storage-options');
            if (deviceTypeSelect.value === 'storage') {
                storageOptions.style.display = 'block';
            } else {
                storageOptions.style.display = 'none';
            }
        }
        
        deviceTypeSelect.addEventListener('change', updateStorageOptions);
        
        // Инициализация при загрузке страницы
        updateStorageOptions();
    }
    
    // Функциональность браузера папок
    const folderBrowserModal = document.getElementById('folderBrowserModal');
    if (folderBrowserModal) {
        let currentPath = '/';
        let parentPath = '/';
        let isWritable = false;
        
        // Функция для загрузки директорий
        function loadDirectories(path = '/') {
            const directoryList = document.getElementById('directory_list');
            const errorBlock = document.getElementById('folder_browser_error');
            const currentPathElement = document.getElementById('current_path');
            const writableBadge = document.getElementById('writable_badge');
            
            // Показываем загрузку
            directoryList.innerHTML = `
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading folder list...</p>
                </div>
            `;
            
            // Скрываем ошибку если была
            errorBlock.style.display = 'none';
            
            // Запрашиваем директории с сервера
            fetch(`/get_system_directories?path=${encodeURIComponent(path)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        // Показываем ошибку
                        errorBlock.style.display = 'block';
                        document.getElementById('error_message').textContent = data.error;
                        return;
                    }
                    
                    // Сохраняем текущий и родительский пути
                    currentPath = data.current_path;
                    parentPath = data.parent_path;
                    isWritable = data.writable;
                    
                    // Обновляем отображение текущего пути
                    currentPathElement.textContent = currentPath;
                    
                    // Обновляем статус доступа на запись
                    if (isWritable) {
                        writableBadge.className = 'badge bg-success';
                        writableBadge.textContent = 'Writable';
                    } else {
                        writableBadge.className = 'badge bg-danger';
                        writableBadge.textContent = 'Read Only';
                    }
                    
                    // Обновляем хлебные крошки
                    updateBreadcrumbs(currentPath);
                    
                    // Если нет директорий и файлов, показываем сообщение
                    if (data.directories.length === 0 && data.files.length === 0) {
                        directoryList.innerHTML = `
                            <div class="alert alert-info m-3">
                                <i class="fas fa-info-circle me-2"></i>This directory is empty
                            </div>
                        `;
                        return;
                    }
                    
                    // Отображаем список директорий и файлов
                    let html = '<div class="list-group">';
                    
                    // Сначала показываем директории
                    data.directories.forEach(dir => {
                        const rowClass = dir.writable ? 'list-group-item-action' : 'text-muted';
                        const writableIcon = dir.writable 
                            ? '<i class="fas fa-pencil-alt text-success ms-2" title="Writable"></i>' 
                            : '<i class="fas fa-lock text-danger ms-2" title="Read Only"></i>';
                            
                        html += `
                            <a href="#" class="list-group-item ${rowClass} d-flex align-items-center folder-item"
                               ${dir.writable ? `data-path="${dir.path}"` : 'disabled'}>
                                <i class="fas fa-folder me-2 text-warning"></i>
                                <span class="flex-grow-1">${dir.name}</span>
                                ${writableIcon}
                            </a>
                        `;
                    });
                    
                    // Затем файлы в сером цвете (не кликабельные)
                    data.files.forEach(file => {
                        const fileSize = formatFileSize(file.size);
                        html += `
                            <div class="list-group-item text-muted d-flex align-items-center">
                                <i class="fas fa-file me-2"></i>
                                <span class="flex-grow-1">${file.name}</span>
                                <small>${fileSize}</small>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    directoryList.innerHTML = html;
                    
                    // Добавляем обработчики для директорий
                    document.querySelectorAll('.folder-item').forEach(item => {
                        if (item.getAttribute('data-path')) {
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                const path = this.getAttribute('data-path');
                                loadDirectories(path);
                            });
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading directories:', error);
                    errorBlock.style.display = 'block';
                    document.getElementById('error_message').textContent = 'Error loading directory list';
                });
        }
        
        // Функция для обновления хлебных крошек
        function updateBreadcrumbs(path) {
            const breadcrumb = document.getElementById('folder_breadcrumb');
            const parts = path.split('/').filter(part => part.length > 0);
            
            // Очищаем текущие хлебные крошки
            breadcrumb.innerHTML = `<li class="breadcrumb-item"><a href="#" data-path="/">Root</a></li>`;
            
            let currentPath = '/';
            parts.forEach((part, index) => {
                currentPath += part + '/';
                const isLast = index === parts.length - 1;
                
                const item = document.createElement('li');
                item.className = 'breadcrumb-item';
                if (isLast) item.classList.add('active');
                
                if (isLast) {
                    item.textContent = part;
                } else {
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = part;
                    link.setAttribute('data-path', currentPath);
                    item.appendChild(link);
                }
                
                breadcrumb.appendChild(item);
            });
            
            // Добавляем обработчики для хлебных крошек
            document.querySelectorAll('#folder_breadcrumb a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const path = this.getAttribute('data-path');
                    loadDirectories(path);
                });
            });
        }
        
        // Функция для форматирования размера файла
        function formatFileSize(size) {
            if (size < 1024) return size + ' B';
            if (size < 1024 * 1024) return (size / 1024).toFixed(1) + ' KB';
            if (size < 1024 * 1024 * 1024) return (size / (1024 * 1024)).toFixed(1) + ' MB';
            return (size / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }
        
        // Инициализация модального окна выбора папки
        folderBrowserModal.addEventListener('show.bs.modal', function() {
            // Загружаем директории
            loadDirectories('/');
        });
        
        // Обработчик кнопки "Вверх"
        document.getElementById('parent_dir_button').addEventListener('click', function() {
            loadDirectories(parentPath);
        });
        
        // Обработчик кнопки "Обновить"
        document.getElementById('refresh_dir_button').addEventListener('click', function() {
            loadDirectories(currentPath);
        });
        
        // Обработчик выбора папки
        document.getElementById('select_folder_button').addEventListener('click', function() {
            if (!isWritable) {
                alert('Directory is not writable');
                return;
            }
            
            // Устанавливаем выбранный путь
            document.getElementById('system_path').value = currentPath;
            
            // Закрываем модальное окно без скрытия основного модального окна
            const modal = bootstrap.Modal.getInstance(folderBrowserModal);
            modal.hide();
            
            // Убедимся, что основное модальное окно остается видимым
            setTimeout(function() {
                // Сфокусируемся на основном модальном окне и предотвратим его закрытие
                const mainModal = document.getElementById('createDeviceModal');
                if (mainModal) {
                    mainModal.classList.add('show');
                    mainModal.style.display = 'block';
                    document.body.classList.add('modal-open');
                    
                    // Если был затемняющий фон, восстановим его
                    let backdrop = document.querySelector('.modal-backdrop');
                    if (!backdrop) {
                        backdrop = document.createElement('div');
                        backdrop.className = 'modal-backdrop fade show';
                        document.body.appendChild(backdrop);
                    }
                }
            }, 100);
        });
    }
});
</script>
{% endblock %}