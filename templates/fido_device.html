{% extends "base.html" %}

{% block title %}FIDO2 Virtual Device - OrangeUSB{% endblock %}

{% block extra_css %}
<style>
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    .status-running {
        background-color: #28a745;
        box-shadow: 0 0 8px #28a745;
    }
    .status-stopped {
        background-color: #6c757d;
    }
    .fido-action-btn {
        min-width: 120px;
    }
    .credential-badge {
        font-size: 0.85em;
        padding: 0.4em 0.8em;
    }
    .log-timestamp {
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }
    .info-row {
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .info-row:last-child {
        border-bottom: none;
    }
    .info-label {
        font-weight: 600;
        color: #adb5bd;
    }
    .info-value {
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="bi bi-shield-lock"></i> 
            FIDO2 Virtual Security Key
        </h2>
        <div>
            <button class="btn btn-info me-2" data-bs-toggle="collapse" data-bs-target="#helpSection">
                <i class="bi bi-question-circle"></i> Quick Help
            </button>
            <button class="btn btn-outline-secondary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Help Section (Collapsible) -->
    <div class="collapse mb-4" id="helpSection">
        <div class="card bg-info bg-opacity-10 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-lightbulb"></i> How to Use FIDO2 Virtual Device
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-info"><i class="bi bi-1-circle"></i> First Start</h6>
                        <ol class="small">
                            <li>Click the <span class="badge bg-success">Start Device</span> button to launch the virtual device</li>
                            <li>Wait for the green status indicator to appear</li>
                            <li>Device is ready to use!</li>
                        </ol>

                        <h6 class="text-info mt-3"><i class="bi bi-2-circle"></i> Website Registration</h6>
                        <ol class="small">
                            <li>Open any website with WebAuthn/FIDO2 support</li>
                            <li>Select login via security key option</li>
                            <li>Credential will be automatically saved to vault</li>
                            <li>You'll see it in the "Registered Credentials" table</li>
                        </ol>

                        <h6 class="text-info mt-3"><i class="bi bi-3-circle"></i> Testing Your Device</h6>
                        <p class="small mb-2"><strong>Step 1: Choose a test site</strong></p>
                        <ul class="small mb-2">
                            <li><strong>Yubico Demo</strong> - demo.yubico.com/webauthn</li>
                            <li><strong>WebAuthn.io</strong> - webauthn.io</li>
                        </ul>
                        
                        <p class="small mb-2"><strong>Step 2: Create a test account</strong></p>
                        <div class="alert alert-info alert-sm mb-2" style="font-size: 0.85rem; padding: 0.5rem;">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Important:</strong> You need to register a temporary demo account on the test site. 
                            This is <strong>NOT a real registration</strong> - accounts expire after 24 hours and are only used for testing.
                            Use any credentials (e.g., username: "test123", password: "test123456").
                        </div>
                        
                        <p class="small mb-2"><strong>Step 3: Register your security key</strong></p>
                        <ol class="small mb-0" style="font-size: 0.85rem;">
                            <li>After creating account, look for "Add authenticator" or "Register security key" button</li>
                            <li>Click it - browser will ask: "Use your security key with..."</li>
                            <li>Click "Allow" or "OK"</li>
                            <li>New credential will appear in "Registered Credentials" section below</li>
                            <li>Success! Your FIDO2 device is working! ✅</li>
                        </ol>
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="text-warning"><i class="bi bi-exclamation-triangle"></i> Important Notes</h6>
                        <ul class="small">
                            <li><strong>Vault file:</strong> All credentials stored in <code>/home/runner/fido_data/vault.json</code></li>
                            <li><strong>Security:</strong> Create regular backups of the vault file</li>
                            <li><strong>Stopping device:</strong> Authentication becomes impossible when device is stopped</li>
                            <li><strong>Deleting credentials:</strong> Be careful - deleted credentials cannot be recovered</li>
                        </ul>

                        <h6 class="text-success mt-3"><i class="bi bi-info-circle"></i> Useful Commands</h6>
                        <div class="small">
                            <p class="mb-1"><strong>Create backup:</strong> Click "Backup Vault" in Quick Actions</p>
                            <p class="mb-1"><strong>Check status:</strong> "Check Status" button refreshes information</p>
                            <p class="mb-1"><strong>Auto-refresh:</strong> Status automatically updates every 30 seconds</p>
                        </div>

                        <div class="alert alert-success alert-sm mt-3 mb-0">
                            <small>
                                <i class="bi bi-check-circle"></i> 
                                <strong>Auto-Approval Enabled:</strong> All FIDO operations are automatically approved without manual confirmation - just click "Allow" in your browser!
                            </small>
                        </div>

                        <div class="alert alert-warning alert-sm mt-2 mb-0">
                            <small>
                                <i class="bi bi-shield-check"></i> 
                                <strong>Protocols:</strong> Device supports FIDO2, U2F and WebAuthn
                            </small>
                        </div>
                    </div>
                </div>

                <hr class="my-3">
                
                <div class="text-center">
                    <a href="{{ url_for('fido.help_page') }}" class="btn btn-outline-info btn-sm" target="_blank">
                        <i class="bi bi-book"></i> Open Detailed Guide
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
                    <i class="bi bi-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' }}"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row g-3">
        <!-- Left Column: Device Control and Info -->
        <div class="col-lg-8">
            <!-- Device Status Card -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-gear"></i> Device Control
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-3">
                                <span class="status-indicator {% if device.is_running %}status-running{% else %}status-stopped{% endif %}" id="status-indicator"></span>
                                <span id="status-text">
                                    {% if device.is_running %}
                                        <span class="text-success">Running</span>
                                    {% else %}
                                        <span class="text-secondary">Stopped</span>
                                    {% endif %}
                                </span>
                            </h4>
                            <div class="info-row">
                                <span class="info-label">PID:</span>
                                <span class="info-value" id="device-pid">
                                    {% if device.pid %}{{ device.pid }}{% else %}N/A{% endif %}
                                </span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Started:</span>
                                <span class="info-value">
                                    {% if device.started_at %}
                                        {{ device.started_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                    {% else %}
                                        Never
                                    {% endif %}
                                </span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Auto-start:</span>
                                <span class="info-value">
                                    {% if device.auto_start %}
                                        <span class="badge bg-success">Enabled</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Disabled</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        
                        <div class="col-md-6 text-center">
                            {% if device.is_running %}
                                <button class="btn btn-danger fido-action-btn mb-2" onclick="controlDevice('stop')" id="stop-btn">
                                    <i class="bi bi-stop-circle"></i> Stop Device
                                </button>
                            {% else %}
                                <button class="btn btn-success fido-action-btn mb-2" onclick="controlDevice('start')" id="start-btn">
                                    <i class="bi bi-play-circle"></i> Start Device
                                </button>
                            {% endif %}
                            <br>
                            <button class="btn btn-outline-info fido-action-btn" onclick="checkStatus()">
                                <i class="bi bi-arrow-clockwise"></i> Check Status
                            </button>
                        </div>
                    </div>

                    {% if device.last_error %}
                    <div class="alert alert-danger mt-3 mb-0">
                        <strong>Last Error:</strong> {{ device.last_error }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Device Information Card -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> Device Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="info-row">
                        <span class="info-label">Binary Status:</span>
                        <span class="info-value">
                            {% if binary_exists %}
                                <span class="badge bg-success"><i class="bi bi-check-circle"></i> Available</span>
                            {% else %}
                                <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Not Found</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Binary Path:</span>
                        <span class="info-value"><code>/home/runner/fido_data/virtual-fido</code></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Vault Path:</span>
                        <span class="info-value"><code>{{ device.vault_path }}</code></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Vault Status:</span>
                        <span class="info-value">
                            {% if vault_info.exists %}
                                <span class="badge bg-success">Exists</span>
                                <small class="text-muted ms-2">{{ vault_info.size }} bytes</small>
                            {% else %}
                                <span class="badge bg-warning">Not Created</span>
                                <small class="text-muted ms-2">Will be created on first use</small>
                            {% endif %}
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Protocol:</span>
                        <span class="info-value">FIDO2 / U2F / WebAuthn</span>
                    </div>
                </div>
            </div>

            <!-- Credentials Card (placeholder) -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-key"></i> Registered Credentials
                        <span class="badge bg-primary credential-badge">{{ credentials|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if credentials %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>RP ID (Domain)</th>
                                        <th>User</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cred in credentials %}
                                    <tr>
                                        <td><code>{{ cred.rp_id }}</code></td>
                                        <td>{{ cred.user_name|default('N/A', true) }}</td>
                                        <td>{{ cred.created_at|default('Unknown', true) }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" onclick="deleteCredential('{{ cred.credential_id }}')">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i> 
                            No credentials registered yet. Visit a WebAuthn-enabled website to register your first credential.
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Storage & Backup Configuration Card -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-hdd"></i> Storage & Backup Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Left Column: Vault Path Configuration -->
                        <div class="col-md-6">
                            <h6 class="mb-3"><i class="bi bi-folder"></i> Vault Path</h6>
                            <div class="mb-3">
                                <label for="vaultPath" class="form-label small">Current Vault Location:</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="vaultPath" value="Loading..." readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="promptVaultPath()">
                                        <i class="bi bi-pencil"></i> Change
                                    </button>
                                </div>
                                <small class="text-muted">Location where credentials are stored</small>
                            </div>
                            
                            <h6 class="mb-3 mt-4"><i class="bi bi-archive"></i> Backup Actions</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-sm btn-success" onclick="createBackup()">
                                    <i class="bi bi-plus-circle"></i> Create New Backup
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="loadBackupHistory()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh Backup List
                                </button>
                            </div>
                        </div>
                        
                        <!-- Right Column: Backup History -->
                        <div class="col-md-6">
                            <h6 class="mb-3"><i class="bi bi-clock-history"></i> Backup History</h6>
                            <div id="backupHistoryContainer" style="max-height: 400px; overflow-y: auto;">
                                <div class="text-center text-muted py-3">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 small">Loading backup history...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Logs and Actions -->
        <div class="col-lg-4">
            <!-- Quick Actions Card -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning"></i> Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="backupVault()">
                            <i class="bi bi-download"></i> Backup Vault
                        </button>
                        <a href="https://demo.yubico.com/webauthn" target="_blank" class="btn btn-outline-success">
                            <i class="bi bi-box-arrow-up-right"></i> Test Device (Yubico Demo)
                        </a>
                        <a href="https://webauthn.io/" target="_blank" class="btn btn-outline-success">
                            <i class="bi bi-box-arrow-up-right"></i> Test Device (WebAuthn.io)
                        </a>
                    </div>
                </div>
            </div>

            <!-- Passphrase Management Card -->
            <div class="card mb-3">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-key"></i> Passphrase Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning alert-sm">
                        <small>
                            <i class="bi bi-exclamation-triangle"></i> 
                            <strong>Warning:</strong> Changing passphrase requires device restart and vault backup.
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="currentPassphrase" class="form-label small">Current Passphrase:</label>
                        <div class="input-group input-group-sm">
                            <input type="password" class="form-control" id="currentPassphrase" value="********" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="showPassphraseBtn" onclick="togglePassphraseVisibility()">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <small class="text-muted" id="passphraseStatus">Loading...</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newPassphrase" class="form-label small">New Passphrase:</label>
                        <input type="password" class="form-control form-control-sm" id="newPassphrase" placeholder="Min. 8 characters">
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirmPassphrase" class="form-label small">Confirm Passphrase:</label>
                        <input type="password" class="form-control form-control-sm" id="confirmPassphrase" placeholder="Re-enter new passphrase">
                    </div>
                    
                    <button class="btn btn-sm btn-warning w-100" onclick="changePassphrase()">
                        <i class="bi bi-shield-lock"></i> Change Passphrase
                    </button>
                </div>
            </div>

            <!-- Logs Viewer Card -->
            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-journal-text"></i> Operation Logs
                            <span id="logCount" class="badge bg-dark">0</span>
                        </h5>
                        <button class="btn btn-sm btn-outline-light" onclick="toggleLogFilters()">
                            <i class="bi bi-funnel"></i> Filters
                        </button>
                    </div>
                </div>
                
                <!-- Filters Section (collapsible) -->
                <div id="logFilters" class="card-body border-bottom" style="display: none;">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label small">Event Type:</label>
                            <select class="form-select form-select-sm" id="filterEventType" onchange="loadLogs()">
                                <option value="all">All Types</option>
                                <option value="device_start">Device Start</option>
                                <option value="device_stop">Device Stop</option>
                                <option value="credential_delete">Credential Delete</option>
                                <option value="vault_backup">Vault Backup</option>
                                <option value="vault_restore">Vault Restore</option>
                                <option value="passphrase_change">Passphrase Change</option>
                                <option value="logs_clear">Logs Clear</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Status:</label>
                            <select class="form-select form-select-sm" id="filterStatus" onchange="loadLogs()">
                                <option value="all">All Status</option>
                                <option value="success">Success</option>
                                <option value="failed">Failed</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Actions:</label>
                            <button class="btn btn-sm btn-danger w-100" onclick="clearOldLogs()">
                                <i class="bi bi-trash"></i> Clear Old Logs
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Logs Table -->
                <div class="card-body p-0">
                    <div id="logsContainer" style="max-height: 500px; overflow-y: auto;">
                        <div class="text-center text-muted py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 small">Loading logs...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Pagination -->
                <div class="card-footer bg-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></small>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-secondary" id="prevPageBtn" onclick="changePage(-1)" disabled>
                                <i class="bi bi-chevron-left"></i> Prev
                            </button>
                            <button class="btn btn-outline-secondary" id="nextPageBtn" onclick="changePage(1)" disabled>
                                Next <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for AJAX control -->
<script>
function controlDevice(action) {
    const button = action === 'start' ? document.getElementById('start-btn') : document.getElementById('stop-btn');
    const originalHtml = button.innerHTML;
    
    // Show loading state
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Loading...';
    
    fetch('/fido/' + action, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to ' + action + ' device');
        button.disabled = false;
        button.innerHTML = originalHtml;
    });
}

function checkStatus() {
    fetch('/fido/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Device status:', data.status);
                const isRunning = data.status.running;
                
                // Update UI
                const indicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                const pidText = document.getElementById('device-pid');
                
                if (isRunning) {
                    indicator.classList.remove('status-stopped');
                    indicator.classList.add('status-running');
                    statusText.innerHTML = '<span class="text-success">Running</span>';
                    pidText.textContent = data.status.pid || 'N/A';
                } else {
                    indicator.classList.remove('status-running');
                    indicator.classList.add('status-stopped');
                    statusText.innerHTML = '<span class="text-secondary">Stopped</span>';
                    pidText.textContent = 'N/A';
                }
                
                alert('Status updated successfully!');
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to check status');
        });
}

function backupVault() {
    if (!confirm('Create backup of FIDO vault?')) {
        return;
    }
    
    fetch('/fido/vault/backup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Vault backup created successfully!\n\nBackup location: ' + data.backup_path);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create backup');
    });
}

function deleteCredential(credentialId) {
    if (!confirm('Delete this credential? This action cannot be undone.')) {
        return;
    }
    
    fetch('/fido/credentials/' + credentialId, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete credential');
    });
}

// Passphrase management functions
let passphraseVisible = false;

function loadPassphraseStatus() {
    fetch('/fido/passphrase/get')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const statusEl = document.getElementById('passphraseStatus');
                const currentPassEl = document.getElementById('currentPassphrase');
                
                currentPassEl.value = data.masked;
                
                if (data.is_default) {
                    statusEl.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> Using default passphrase (insecure)';
                } else {
                    statusEl.innerHTML = '<i class="bi bi-shield-check text-success"></i> Custom passphrase set (' + data.length + ' chars)';
                }
            }
        })
        .catch(error => {
            console.error('Error loading passphrase status:', error);
        });
}

function togglePassphraseVisibility() {
    const currentPassEl = document.getElementById('currentPassphrase');
    const btnIcon = document.querySelector('#showPassphraseBtn i');
    
    passphraseVisible = !passphraseVisible;
    currentPassEl.type = passphraseVisible ? 'text' : 'password';
    btnIcon.className = passphraseVisible ? 'bi bi-eye-slash' : 'bi bi-eye';
}

function changePassphrase() {
    const newPass = document.getElementById('newPassphrase').value;
    const confirmPass = document.getElementById('confirmPassphrase').value;
    
    if (!newPass || !confirmPass) {
        alert('Please enter both passphrase fields');
        return;
    }
    
    if (newPass.length < 8) {
        alert('Passphrase must be at least 8 characters long');
        return;
    }
    
    if (newPass !== confirmPass) {
        alert('Passphrases do not match');
        return;
    }
    
    if (!confirm('WARNING: Changing passphrase requires:\n\n1. Device restart\n2. Vault backup (recommended)\n\nContinue?')) {
        return;
    }
    
    fetch('/fido/passphrase/change', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            new_passphrase: newPass
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Passphrase updated successfully!\n\nPlease restart the device for changes to take effect.');
            document.getElementById('newPassphrase').value = '';
            document.getElementById('confirmPassphrase').value = '';
            loadPassphraseStatus();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to change passphrase');
    });
}

// Storage & Backup Configuration Functions
function loadVaultPath() {
    fetch('/fido/vault/path')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('vaultPath').value = data.path;
            }
        })
        .catch(error => {
            console.error('Error loading vault path:', error);
        });
}

function promptVaultPath() {
    const currentPath = document.getElementById('vaultPath').value;
    const newPath = prompt('Enter new vault file path:', currentPath);
    
    if (!newPath || newPath === currentPath) {
        return;
    }
    
    if (!confirm('WARNING: Changing vault path will affect where credentials are stored.\n\nContinue?')) {
        return;
    }
    
    fetch('/fido/vault/path', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            path: newPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Vault path updated successfully!\n\nPath: ' + data.path);
            loadVaultPath();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update vault path');
    });
}

function loadBackupHistory() {
    const container = document.getElementById('backupHistoryContainer');
    container.innerHTML = '<div class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm"></div><p class="mt-2 small">Loading...</p></div>';
    
    fetch('/fido/vault/backups')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.backups.length > 0) {
                let html = '<div class="list-group list-group-flush">';
                data.backups.forEach(backup => {
                    html += '<div class="list-group-item bg-dark border-secondary d-flex justify-content-between align-items-start">';
                    html += '<div class="flex-grow-1">';
                    html += '<div class="fw-bold small"><i class="bi bi-file-earmark-zip"></i> ' + backup.filename + '</div>';
                    html += '<small class="text-muted">' + backup.created_at + ' • ' + backup.size_mb + ' MB</small>';
                    html += '</div>';
                    html += '<div class="btn-group btn-group-sm" role="group">';
                    html += '<button class="btn btn-outline-success" onclick="restoreBackup(\'' + backup.filename + '\')" title="Restore"><i class="bi bi-arrow-clockwise"></i></button>';
                    html += '<button class="btn btn-outline-primary" onclick="downloadBackup(\'' + backup.filename + '\')" title="Download"><i class="bi bi-download"></i></button>';
                    html += '<button class="btn btn-outline-danger" onclick="deleteBackupConfirm(\'' + backup.filename + '\')" title="Delete"><i class="bi bi-trash"></i></button>';
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="alert alert-secondary mb-0 small"><i class="bi bi-info-circle"></i> No backups found</div>';
            }
        })
        .catch(error => {
            console.error('Error loading backups:', error);
            container.innerHTML = '<div class="alert alert-danger mb-0 small"><i class="bi bi-exclamation-triangle"></i> Error loading backups</div>';
        });
}

function createBackup() {
    if (!confirm('Create a backup of the current vault?')) {
        return;
    }
    
    fetch('/fido/vault/backup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Backup created successfully!\n\nFile: ' + data.filename + '\nTime: ' + data.timestamp);
            loadBackupHistory();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create backup');
    });
}

function restoreBackup(filename) {
    if (!confirm('RESTORE vault from backup?\n\nFile: ' + filename + '\n\nCurrent vault will be backed up before restore.\n\nContinue?')) {
        return;
    }
    
    fetch('/fido/vault/restore', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            backup_filename: filename
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Vault restored successfully!\n\nFrom: ' + data.filename);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to restore vault');
    });
}

function deleteBackupConfirm(filename) {
    if (!confirm('DELETE backup file?\n\nFile: ' + filename + '\n\nThis action cannot be undone.')) {
        return;
    }
    
    fetch('/fido/vault/backup/' + filename, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Backup deleted: ' + filename);
            loadBackupHistory();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete backup');
    });
}

function downloadBackup(filename) {
    window.location.href = '/fido/vault/backup/' + filename + '/download';
}

// Logs Viewer Functions
let currentPage = 1;
const logsPerPage = 50;

function toggleLogFilters() {
    const filters = document.getElementById('logFilters');
    if (filters.style.display === 'none') {
        filters.style.display = 'block';
    } else {
        filters.style.display = 'none';
    }
}

function loadLogs(page = 1) {
    currentPage = page;
    const eventType = document.getElementById('filterEventType').value;
    const status = document.getElementById('filterStatus').value;
    
    const params = new URLSearchParams({
        page: currentPage,
        per_page: logsPerPage
    });
    
    if (eventType && eventType !== 'all') {
        params.append('event_type', eventType);
    }
    
    if (status && status !== 'all') {
        params.append('status', status);
    }
    
    fetch('/fido/logs?' + params.toString())
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayLogs(data.logs);
                updatePagination(data.pagination);
            } else {
                document.getElementById('logsContainer').innerHTML = 
                    '<div class="alert alert-danger m-3">Error loading logs: ' + data.message + '</div>';
            }
        })
        .catch(error => {
            console.error('Error loading logs:', error);
            document.getElementById('logsContainer').innerHTML = 
                '<div class="alert alert-danger m-3">Failed to load logs</div>';
        });
}

function displayLogs(logs) {
    const container = document.getElementById('logsContainer');
    
    if (logs.length === 0) {
        container.innerHTML = 
            '<div class="alert alert-secondary m-3">' +
            '<i class="bi bi-inbox"></i> No logs found' +
            '</div>';
        document.getElementById('logCount').textContent = '0';
        return;
    }
    
    let html = '<table class="table table-dark table-striped table-hover mb-0">';
    html += '<thead>';
    html += '<tr>';
    html += '<th style="width: 140px;">Timestamp</th>';
    html += '<th style="width: 150px;">Event Type</th>';
    html += '<th style="width: 80px;">Status</th>';
    html += '<th>RP ID / Details</th>';
    html += '<th style="width: 100px;">IP Address</th>';
    html += '</tr>';
    html += '</thead>';
    html += '<tbody>';
    
    logs.forEach(log => {
        const statusClass = log.status === 'success' ? 'success' : 
                          log.status === 'failed' ? 'danger' : 'warning';
        
        html += '<tr>';
        html += '<td><small>' + log.timestamp + '</small></td>';
        html += '<td><span class="badge bg-primary">' + log.event_type + '</span></td>';
        html += '<td><span class="badge bg-' + statusClass + '">' + log.status + '</span></td>';
        html += '<td>';
        if (log.rp_id) {
            html += '<strong>' + log.rp_id + '</strong><br>';
        }
        if (log.details) {
            html += '<small class="text-muted">' + log.details + '</small>';
        }
        html += '</td>';
        html += '<td><small>' + (log.ip_address || 'N/A') + '</small></td>';
        html += '</tr>';
    });
    
    html += '</tbody>';
    html += '</table>';
    
    container.innerHTML = html;
    document.getElementById('logCount').textContent = logs.length;
}

function updatePagination(pagination) {
    document.getElementById('currentPage').textContent = pagination.page;
    document.getElementById('totalPages').textContent = pagination.pages;
    
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    
    prevBtn.disabled = !pagination.has_prev;
    nextBtn.disabled = !pagination.has_next;
}

function changePage(delta) {
    loadLogs(currentPage + delta);
}

function clearOldLogs() {
    const days = prompt('Clear logs older than how many days?\n\nEnter number of days (default: 30):', '30');
    
    if (days === null) {
        return; // User cancelled
    }
    
    const daysNum = parseInt(days);
    if (isNaN(daysNum) || daysNum < 1) {
        alert('Please enter a valid number of days');
        return;
    }
    
    if (!confirm('Clear all logs older than ' + daysNum + ' days?\n\nThis action cannot be undone.')) {
        return;
    }
    
    fetch('/fido/logs/clear', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            days: daysNum
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message + '\n\nDeleted: ' + data.deleted_count + ' log entries');
            loadLogs(1); // Reload first page
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to clear logs');
    });
}

// Load passphrase status and vault path on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPassphraseStatus();
    loadVaultPath();
    loadBackupHistory();
    loadLogs(1); // Load first page of logs
});

// Auto-refresh status every 30 seconds
setInterval(function() {
    fetch('/fido/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const isRunning = data.status.running;
                const indicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                const pidText = document.getElementById('device-pid');
                
                if (isRunning) {
                    indicator.classList.remove('status-stopped');
                    indicator.classList.add('status-running');
                    statusText.innerHTML = '<span class="text-success">Running</span>';
                    pidText.textContent = data.status.pid || 'N/A';
                } else {
                    indicator.classList.remove('status-running');
                    indicator.classList.add('status-stopped');
                    statusText.innerHTML = '<span class="text-secondary">Stopped</span>';
                    pidText.textContent = 'N/A';
                }
            }
        })
        .catch(error => console.error('Auto-refresh error:', error));
}, 30000);
</script>
{% endblock %}
