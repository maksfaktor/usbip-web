{% extends 'base.html' %}

{% block title %}{{ t('usb_devices') }} - {{ t('app_name') }}{% endblock %}

{% block content %}
<div class="container-fluid my-3">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10">
            <div class="card shadow border-0">
                <div class="card-header bg-dark">
                    <h4 class="card-title mb-0 text-white">
                        <i class="bi bi-usb-drive me-2"></i>{{ t('usb_devices') }}
                    </h4>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <div class="mb-4">
                        <h5>
                            <i class="bi bi-hdd me-2"></i>{{ t('local_usb_devices') }}
                        </h5>
                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle-fill me-2"></i>{{ t('local_devices_info') }}
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>{{ t('busid') }}</th>
                                        <th>{{ t('device_name') }}</th>
                                        <th>{{ t('alias') }}</th>
                                        <th>{{ t('status') }}</th>
                                        <th>{{ t('actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if local_devices %}
                                        {% for device in local_devices %}
                                            <tr>
                                                <td>{{ device.busid }}</td>
                                                <td>{{ device.info }}</td>
                                                <td>{{ device.alias or t('no_alias') }}</td>
                                                <td>
                                                    <span id="status-{{ device.busid }}">{{ t('unknown') }}</span>
                                                </td>
                                                <td>
                                                    <div class="btn-group">
                                                        <button class="btn btn-sm btn-primary bind-device-btn" 
                                                                data-busid="{{ device.busid }}"
                                                                id="bind-btn-{{ device.busid }}">
                                                            <i class="bi bi-share me-1"></i>{{ t('publish') }}
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary edit-alias-btn"
                                                                data-busid="{{ device.busid }}"
                                                                data-alias="{{ device.alias or '' }}"
                                                                data-info="{{ device.info }}">
                                                            <i class="bi bi-pencil-square me-1"></i>{{ t('set_alias') }}
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center py-3">
                                                <div class="alert alert-warning mb-0">
                                                    <i class="bi bi-exclamation-triangle me-2"></i>{{ t('no_usb_devices_detected') }}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для алиасов -->
<div class="modal fade" id="aliasModal" tabindex="-1" aria-labelledby="aliasModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aliasModalLabel">{{ t('set_device_alias') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="aliasForm" method="post" action="{{ url_for('device_alias') }}">
                    <input type="hidden" id="busid" name="busid" value="">
                    <input type="hidden" id="device_info" name="device_info" value="">
                    
                    <div class="mb-3">
                        <label for="device_name" class="form-label">{{ t('device') }}</label>
                        <input type="text" class="form-control" id="device_name" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="alias" class="form-label">{{ t('alias') }}</label>
                        <input type="text" class="form-control" id="alias" name="alias" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">{{ t('save') }}</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Инициализация модальных окон
    document.addEventListener('DOMContentLoaded', function() {
        // Обработчик кнопки редактирования алиаса
        const editAliasBtns = document.querySelectorAll('.edit-alias-btn');
        editAliasBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const busid = this.getAttribute('data-busid');
                const alias = this.getAttribute('data-alias');
                const info = this.getAttribute('data-info');
                
                document.getElementById('busid').value = busid;
                document.getElementById('device_info').value = info;
                document.getElementById('device_name').value = info;
                document.getElementById('alias').value = alias;
                
                // Показываем модальное окно
                new bootstrap.Modal(document.getElementById('aliasModal')).show();
            });
        });

        // Обработчик кнопок bind (публикации) устройств
        const bindDeviceBtns = document.querySelectorAll('.bind-device-btn');
        bindDeviceBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const busid = this.getAttribute('data-busid');
                const statusSpan = document.getElementById(`status-${busid}`);
                const bindBtn = document.getElementById(`bind-btn-${busid}`);
                
                // Показываем индикатор загрузки
                bindBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>{{ t("publishing") }}';
                bindBtn.disabled = true;
                
                // Отправляем запрос на публикацию устройства
                fetch(`/bind-device/${busid}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusSpan.textContent = '{{ t("published") }}';
                        statusSpan.className = 'badge bg-success';
                        bindBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>{{ t("published") }}';
                        bindBtn.disabled = true;
                    } else {
                        statusSpan.textContent = '{{ t("error") }}';
                        statusSpan.className = 'badge bg-danger';
                        bindBtn.innerHTML = '<i class="bi bi-x-circle me-1"></i>{{ t("publish_error") }}';
                        bindBtn.disabled = false;
                        alert(data.message || '{{ t("unknown_error") }}');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusSpan.textContent = '{{ t("error") }}';
                    statusSpan.className = 'badge bg-danger';
                    bindBtn.innerHTML = '<i class="bi bi-x-circle me-1"></i>{{ t("publish_error") }}';
                    bindBtn.disabled = false;
                    alert('{{ t("server_error") }}');
                });
            });
        });
    });
</script>
{% endblock %}