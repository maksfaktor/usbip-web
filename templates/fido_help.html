{% extends "base.html" %}

{% block title %}FIDO2 Device Help - OrangeUSB{% endblock %}

{% block extra_css %}
<style>
    .help-section {
        margin-bottom: 2rem;
    }
    .step-number {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
    }
    .command-box {
        background: #1a1d23;
        border-left: 4px solid #667eea;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 4px;
    }
    .screenshot-placeholder {
        background: #2d3748;
        border: 2px dashed #4a5568;
        padding: 60px 20px;
        text-align: center;
        color: #a0aec0;
        border-radius: 8px;
        margin: 1rem 0;
    }
    .tip-box {
        background: #1e3a5f;
        border-left: 4px solid #3b82f6;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 4px;
    }
    .warning-box {
        background: #4a2617;
        border-left: 4px solid #f59e0b;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-10 offset-lg-1">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-4">
                    <i class="bi bi-shield-lock text-primary"></i>
                    FIDO2 Virtual Security Key
                </h1>
                <p class="lead text-muted">Complete guide for using the virtual FIDO2 device</p>
                <a href="{{ url_for('fido.device_page') }}" class="btn btn-primary">
                    <i class="bi bi-arrow-left"></i> Back to Device
                </a>
            </div>

            <!-- Table of Contents -->
            <div class="card mb-4 bg-dark">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-list"></i> Table of Contents</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><a href="#what-is-fido2">1. What is FIDO2?</a></li>
                                <li><a href="#first-start">2. First Start</a></li>
                                <li><a href="#registration">3. Website Registration</a></li>
                                <li><a href="#authentication">4. Authentication</a></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><a href="#credentials">5. Credentials Management</a></li>
                                <li><a href="#backup">6. Backup & Restore</a></li>
                                <li><a href="#troubleshooting">7. Troubleshooting</a></li>
                                <li><a href="#faq">8. FAQ</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 1: What is FIDO2 -->
            <div class="help-section" id="what-is-fido2">
                <div class="card bg-dark">
                    <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h3 class="text-white mb-0">
                            <i class="bi bi-info-circle"></i> What is FIDO2?
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="lead">FIDO2 (Fast IDentity Online) is a modern passwordless authentication standard developed by the FIDO Alliance.</p>
                        
                        <h5 class="mt-4">Key Benefits:</h5>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <div class="text-center p-3">
                                    <i class="bi bi-shield-check text-success" style="font-size: 3rem;"></i>
                                    <h6 class="mt-2">Security</h6>
                                    <p class="small text-muted">Protection from phishing and man-in-the-middle attacks</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3">
                                    <i class="bi bi-lightning text-warning" style="font-size: 3rem;"></i>
                                    <h6 class="mt-2">Convenience</h6>
                                    <p class="small text-muted">Login without password with one click</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3">
                                    <i class="bi bi-globe text-primary" style="font-size: 3rem;"></i>
                                    <h6 class="mt-2">Universal</h6>
                                    <p class="small text-muted">Works on thousands of websites worldwide</p>
                                </div>
                            </div>
                        </div>

                        <div class="tip-box mt-4">
                            <h6><i class="bi bi-lightbulb text-info"></i> What does the virtual device do?</h6>
                            <p class="mb-0">Emulates a physical USB security key (like YubiKey) at the software level. All credentials are stored in an encrypted vault.json file on your server.</p>
                        </div>

                        <h5 class="mt-4">Supported Protocols:</h5>
                        <ul>
                            <li><strong>FIDO2 (WebAuthn)</strong> - latest standard, used on most modern websites</li>
                            <li><strong>U2F</strong> - previous generation, compatibility with legacy systems</li>
                            <li><strong>CTAP2</strong> - communication protocol between browser and device</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Section 2: First Start -->
            <div class="help-section" id="first-start">
                <div class="card bg-dark">
                    <div class="card-header bg-success">
                        <h3 class="text-white mb-0">
                            <i class="bi bi-play-circle"></i> First Start
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-start mb-4">
                            <div class="step-number">1</div>
                            <div>
                                <h5>Open FIDO2 Device Page</h5>
                                <p>Navigate to the <strong>FIDO2 Device</strong> section in the navigation menu</p>
                            </div>
                        </div>

                        <div class="d-flex align-items-start mb-4">
                            <div class="step-number">2</div>
                            <div>
                                <h5>Click Start Device Button</h5>
                                <p>In the "Device Control" section, click the green <span class="badge bg-success">Start Device</span> button</p>
                                <div class="command-box">
                                    <code>On start, the device executes:<br>
                                    /home/runner/fido_data/virtual-fido start --vault /home/runner/fido_data/vault.json --passphrase "passphrase"</code>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-start mb-4">
                            <div class="step-number">3</div>
                            <div>
                                <h5>Wait for Startup</h5>
                                <p>The status indicator will turn green and show the process PID. Device is ready to use!</p>
                                <div class="tip-box">
                                    <p class="mb-0"><i class="bi bi-info-circle"></i> <strong>Auto-update:</strong> Device status automatically refreshes every 30 seconds</p>
                                </div>
                            </div>
                        </div>

                        <div class="warning-box">
                            <h6><i class="bi bi-exclamation-triangle"></i> Important!</h6>
                            <ul class="mb-0">
                                <li>Device must be running for registration and authentication</li>
                                <li>When server stops, device will automatically stop</li>
                                <li>Vault file is created automatically on first registration</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Registration -->
            <div class="help-section" id="registration">
                <div class="card bg-dark">
                    <div class="card-header bg-info">
                        <h3 class="text-white mb-0">
                            <i class="bi bi-person-plus"></i> Website Registration
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="lead">Process of creating a new credential for a website:</p>

                        <div class="d-flex align-items-start mb-4">
                            <div class="step-number">1</div>
                            <div>
                                <h5>Open Test Website</h5>
                                <p>For first test, we recommend:</p>
                                <ul>
                                    <li><a href="https://demo.yubico.com/webauthn" target="_blank">https://demo.yubico.com/webauthn</a></li>
                                    <li><a href="https://webauthn.io/" target="_blank">https://webauthn.io/</a></li>
                                </ul>
                                <div class="tip-box">
                                    <p class="mb-0">These links are also available on the main FIDO device page in the "Quick Actions" section</p>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-start mb-4">
                            <div class="step-number">2</div>
                            <div>
                                <h5>Start Registration</h5>
                                <p>On the website, find "Register with Security Key" or "Sign up with WebAuthn" option</p>
                                <p>Enter your details (username, email - depends on website)</p>
                            </div>
                        </div>

                        <div class="d-flex align-items-start mb-4">
                            <div class="step-number">3</div>
                            <div>
                                <h5>Confirm Registration</h5>
                                <p>Browser will show "Insert security key" dialog. Virtual device will automatically respond to the request.</p>
                                <div class="warning-box">
                                    <p class="mb-0"><i class="bi bi-exclamation-triangle"></i> <strong>Note:</strong> If browser doesn't see device, make sure FIDO device is running (green indicator)</p>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-start mb-4">
                            <div class="step-number">4</div>
                            <div>
                                <h5>Verify Credential</h5>
                                <p>After successful registration, return to FIDO device page. A new entry will appear in "Registered Credentials" table with:</p>
                                <ul>
                                    <li><strong>RP ID:</strong> website domain (e.g., demo.yubico.com)</li>
                                    <li><strong>User:</strong> your username</li>
                                    <li><strong>Created:</strong> registration date and time</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4: Authentication -->
            <div class="help-section" id="authentication">
                <div class="card bg-dark">
                    <div class="card-header bg-warning text-dark">
                        <h3 class="mb-0">
                            <i class="bi bi-key"></i> Authentication
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="lead">Login to website using saved credential:</p>

                        <ol>
                            <li class="mb-3">
                                <strong>Ensure FIDO device is running</strong> (green indicator)
                            </li>
                            <li class="mb-3">
                                <strong>Open the website</strong> where you registered
                            </li>
                            <li class="mb-3">
                                <strong>Select Security Key login</strong> instead of password
                            </li>
                            <li class="mb-3">
                                <strong>Browser will automatically find credential</strong> for this domain
                            </li>
                            <li class="mb-3">
                                <strong>Confirm login</strong> - you'll be authenticated without entering password!
                            </li>
                        </ol>

                        <div class="tip-box">
                            <h6><i class="bi bi-lightbulb"></i> FIDO2 Advantage:</h6>
                            <p class="mb-0">Each credential is bound to a specific domain. Phishing websites cannot steal your credential, even if you try to login through them!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: Credentials Management -->
            <div class="help-section" id="credentials">
                <div class="card bg-dark">
                    <div class="card-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <h3 class="text-white mb-0">
                            <i class="bi bi-key-fill"></i> Credentials Management
                        </h3>
                    </div>
                    <div class="card-body">
                        <h5>Viewing Credentials</h5>
                        <p>All registered credentials are displayed in the table on FIDO device main page.</p>

                        <h5 class="mt-4">Deleting Credential</h5>
                        <div class="warning-box">
                            <h6><i class="bi bi-exclamation-triangle"></i> WARNING!</h6>
                            <p class="mb-0">Credential deletion is irreversible! After deletion, you won't be able to login to the website with this key. You'll need to register again.</p>
                        </div>

                        <p class="mt-3">To delete a credential:</p>
                        <ol>
                            <li>Find the credential in the table</li>
                            <li>Click the <span class="badge bg-danger">Delete</span> button</li>
                            <li>Confirm deletion in the dialog</li>
                        </ol>

                        <div class="command-box mt-3">
                            <p class="mb-1"><strong>Delete command:</strong></p>
                            <code>virtual-fido delete --vault vault.json --passphrase "passphrase" --id [credential_id]</code>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 6: Backup -->
            <div class="help-section" id="backup">
                <div class="card bg-dark">
                    <div class="card-header bg-danger">
                        <h3 class="text-white mb-0">
                            <i class="bi bi-download"></i> Backup & Restore
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="warning-box">
                            <h6><i class="bi bi-exclamation-circle"></i> CRITICALLY IMPORTANT!</h6>
                            <p class="mb-0">The vault file contains ALL your credentials. If you lose it, recovering access to websites will be impossible!</p>
                        </div>

                        <h5 class="mt-4">Creating Backup</h5>
                        <p>Two methods available:</p>

                        <h6>Method 1: Via Web Interface</h6>
                        <ol>
                            <li>On FIDO device page, open "Quick Actions" section</li>
                            <li>Click the <span class="badge bg-primary">Backup Vault</span> button</li>
                            <li>Backup will be created automatically with timestamp in filename</li>
                            <li>Path: <code>/home/runner/fido_data/vault_backup_YYYYMMDD_HHMMSS.json</code></li>
                        </ol>

                        <h6 class="mt-3">Method 2: Manual via SSH</h6>
                        <div class="command-box">
                            <code>cp /home/runner/fido_data/vault.json /home/runner/fido_data/vault_backup_$(date +%Y%m%d_%H%M%S).json</code>
                        </div>

                        <h5 class="mt-4">Restoring from Backup</h5>
                        <div class="warning-box">
                            <p><i class="bi bi-exclamation-triangle"></i> <strong>Before restoring, MUST stop FIDO device!</strong></p>
                        </div>
                        <div class="command-box">
                            <code>cp /home/runner/fido_data/vault_backup_YYYYMMDD_HHMMSS.json /home/runner/fido_data/vault.json</code>
                        </div>

                        <div class="tip-box mt-3">
                            <h6><i class="bi bi-lightbulb"></i> Recommendations:</h6>
                            <ul class="mb-0">
                                <li>Create backup before each credential deletion</li>
                                <li>Store backups in safe location (not on same server)</li>
                                <li>Create regular backups (weekly minimum)</li>
                                <li>Test backup restoration periodically</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 7: Troubleshooting -->
            <div class="help-section" id="troubleshooting">
                <div class="card bg-dark">
                    <div class="card-header bg-secondary">
                        <h3 class="text-white mb-0">
                            <i class="bi bi-tools"></i> Troubleshooting
                        </h3>
                    </div>
                    <div class="card-body">
                        <h5>Problem: Browser doesn't see security key</h5>
                        <p><strong>Solution:</strong></p>
                        <ol>
                            <li>Ensure FIDO device is running (green indicator)</li>
                            <li>Click "Check Status" to refresh information</li>
                            <li>Verify process PID is displayed</li>
                            <li>Try stopping and restarting the device</li>
                        </ol>

                        <h5 class="mt-4">Problem: Device won't start</h5>
                        <p><strong>Solution:</strong></p>
                        <ol>
                            <li>Check binary exists: <code>/home/runner/fido_data/virtual-fido</code></li>
                            <li>Verify file permissions</li>
                            <li>Check "Last Error" on device page</li>
                            <li>Review logs in "Recent Activity" section</li>
                        </ol>

                        <h5 class="mt-4">Problem: Credential won't delete</h5>
                        <p><strong>Solution:</strong></p>
                        <ol>
                            <li>Ensure device is running</li>
                            <li>Check vault file exists and is writable</li>
                            <li>Try stopping device first, then delete credential</li>
                        </ol>

                        <h5 class="mt-4">Problem: Lost access to website</h5>
                        <p><strong>Solution:</strong></p>
                        <ol>
                            <li>Check if credential exists for this domain in table</li>
                            <li>If credential was accidentally deleted - restore from backup</li>
                            <li>If no backup - register again on website</li>
                        </ol>

                        <div class="command-box mt-4">
                            <p class="mb-2"><strong>Diagnostic commands:</strong></p>
                            <code>
                            # Check process<br>
                            ps aux | grep virtual-fido<br><br>
                            # Check vault file<br>
                            ls -lah /home/runner/fido_data/vault.json<br><br>
                            # List credentials manually<br>
                            /home/runner/fido_data/virtual-fido list --vault /home/runner/fido_data/vault.json --passphrase "passphrase"
                            </code>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 8: FAQ -->
            <div class="help-section" id="faq">
                <div class="card bg-dark">
                    <div class="card-header bg-primary">
                        <h3 class="text-white mb-0">
                            <i class="bi bi-question-circle"></i> Frequently Asked Questions
                        </h3>
                    </div>
                    <div class="card-body">
                        <h5>Q: Is virtual FIDO device secure?</h5>
                        <p><strong>A:</strong> Yes, if vault file is properly protected. Credentials are stored encrypted using passphrase. However, physical security key (YubiKey) is more secure as private keys never leave the device.</p>

                        <h5 class="mt-4">Q: Can I use virtual device for production?</h5>
                        <p><strong>A:</strong> For personal use - yes. For critical corporate systems, physical security key is recommended.</p>

                        <h5 class="mt-4">Q: What is RP ID?</h5>
                        <p><strong>A:</strong> Relying Party ID - the website domain for which credential was created. For example: <code>google.com</code>, <code>github.com</code>, <code>demo.yubico.com</code></p>

                        <h5 class="mt-4">Q: How many credentials can be stored?</h5>
                        <p><strong>A:</strong> Technically unlimited. Depends only on vault file size.</p>

                        <h5 class="mt-4">Q: Can I change the passphrase?</h5>
                        <p><strong>A:</strong> Yes, but requires recreating vault file. Current version uses default passphrase "passphrase". Passphrase change feature will be added in future updates.</p>

                        <h5 class="mt-4">Q: Does device work with mobile browsers?</h5>
                        <p><strong>A:</strong> Virtual device runs on server, so accessible only via browser on same server. For mobile devices, use physical security key or platform authenticator (FaceID/TouchID).</p>

                        <h5 class="mt-4">Q: What happens if I delete vault file?</h5>
                        <p><strong>A:</strong> ALL credentials will be lost permanently! You'll need to register again on all websites. This is why regular backups are critically important.</p>

                        <h5 class="mt-4">Q: How to export credentials to another server?</h5>
                        <p><strong>A:</strong> Simply copy vault.json file to new server. Ensure same passphrase is used.</p>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="text-center mt-5 mb-5">
                <a href="{{ url_for('fido.device_page') }}" class="btn btn-lg btn-primary">
                    <i class="bi bi-arrow-left"></i> Back to Device Management
                </a>
            </div>

            <div class="text-center text-muted mb-4">
                <hr>
                <p class="small">
                    <i class="bi bi-info-circle"></i> 
                    Additional information: 
                    <a href="https://github.com/bulwarkid/virtual-fido" target="_blank">virtual-fido GitHub</a> | 
                    <a href="https://fidoalliance.org/" target="_blank">FIDO Alliance</a> |
                    <a href="https://webauthn.guide/" target="_blank">WebAuthn Guide</a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
